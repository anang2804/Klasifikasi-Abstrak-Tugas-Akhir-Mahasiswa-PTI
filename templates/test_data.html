{% extends "base.html" %} {% block title %}Data Uji - Klasifikasi Abstrak PTI{%
endblock %} {% block content %}
<div class="row mb-4">
  <div class="col-12">
    <div class="card bg-info text-white">
      <div class="card-body">
        <h2 class="mb-2">
          <i class="bi bi-clipboard-data"></i> Data Uji (Test Data)
        </h2>
        <p class="mb-0">
          Data hasil klasifikasi dari menu Klasifikasi (input manual & upload
          file)
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card bg-primary text-white">
      <div class="card-body">
        <h5 class="card-title">
          <i class="bi bi-collection"></i> Total Data Uji
        </h5>
        <h2 class="mb-0">{{ stats.total }}</h2>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card bg-success text-white">
      <div class="card-body">
        <h5 class="card-title">
          <i class="bi bi-code-square"></i> Prediksi RPL
        </h5>
        <h2 class="mb-0">{{ stats.rpl }}</h2>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card bg-warning text-white">
      <div class="card-body">
        <h5 class="card-title">
          <i class="bi bi-hdd-network"></i> Prediksi TKJ
        </h5>
        <h2 class="mb-0">{{ stats.tkj }}</h2>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card bg-secondary text-white">
      <div class="card-body">
        <h5 class="card-title"><i class="bi bi-pie-chart"></i> Distribusi</h5>
        <h6 class="mb-0">
          {% if stats.total > 0 %} RPL: {{ ((stats.rpl / stats.total) *
          100)|round(1) }}%<br />
          TKJ: {{ ((stats.tkj / stats.total) * 100)|round(1) }}% {% else %}
          Belum ada data {% endif %}
        </h6>
      </div>
    </div>
  </div>
</div>

<!-- Source Statistics -->
<div class="row mb-4">
  <div class="col-md-6">
    <div class="card">
      <div class="card-body">
        <h6 class="card-title"><i class="bi bi-keyboard"></i> Input Manual</h6>
        <h3 class="mb-0 text-primary">{{ stats.manual }}</h3>
        <small class="text-muted">Dari form input teks</small>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card">
      <div class="card-body">
        <h6 class="card-title">
          <i class="bi bi-file-earmark-arrow-up"></i> Upload File
        </h6>
        <h3 class="mb-0 text-success">{{ stats.upload }}</h3>
        <small class="text-muted">Dari upload TXT/PDF/DOCX</small>
      </div>
    </div>
  </div>
</div>

<!-- Alert jika belum ada data -->
{% if stats.total == 0 %}
<div class="alert alert-info">
  <i class="bi bi-info-circle"></i>
  <strong>Belum ada data uji.</strong>
  Data uji akan muncul setelah Anda melakukan klasifikasi di
  <a href="{{ url_for('classify') }}" class="alert-link">Menu Klasifikasi</a>.
</div>
{% endif %}

<!-- Test Data Table -->
{% if test_data %}
<div class="card">
  <div
    class="card-header bg-white d-flex justify-content-between align-items-center"
  >
    <h5 class="mb-0"><i class="bi bi-table"></i> Daftar Data Uji</h5>
    {% if stats.total > 0 %}
    <button
      type="button"
      class="btn btn-danger btn-sm"
      data-bs-toggle="modal"
      data-bs-target="#clearAllModal"
    >
      <i class="bi bi-trash"></i> Hapus Semua
    </button>
    {% endif %}
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th width="5%">#</th>
            <th width="40%">Teks Abstrak</th>
            <th width="15%">Prediksi</th>
            <th width="12%">Confidence</th>
            <th width="10%">Sumber</th>
            <th width="15%">Waktu Klasifikasi</th>
            <th width="8%">Aksi</th>
          </tr>
        </thead>
        <tbody>
          {% for item in test_data %}
          <tr>
            <td>
              {{ (pagination.page - 1) * pagination.per_page + loop.index }}
            </td>
            <td>
              <div
                class="text-truncate"
                style="max-width: 400px"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                title="{{ item.abstract_text }}"
              >
                {{ item.abstract_text[:150] }} {% if item.abstract_text|length >
                150 %}...{% endif %}
              </div>
            </td>
            <td>
              <span class="badge badge-{{ item.predicted_label.lower() }}">
                {{ item.predicted_label }}
              </span>
            </td>
            <td>
              {% set confidence_percent = (item.confidence * 100)|round(1) %}
              <div class="progress" style="height: 25px">
                <div
                  class="progress-bar {% if item.confidence >= 0.8 %}bg-success {% elif item.confidence >= 0.6 %}bg-warning {% else %}bg-danger{% endif %}"
                  role="progressbar"
                  style="width: {{ confidence_percent }}%"
                  aria-valuenow="{{ confidence_percent }}"
                  aria-valuemin="0"
                  aria-valuemax="100"
                >
                  {{ confidence_percent }}%
                </div>
              </div>
            </td>
            <td>
              {% if item.source == 'manual' %}
              <span class="badge bg-primary">
                <i class="bi bi-keyboard"></i> Manual
              </span>
              {% elif item.source == 'upload' %}
              <span class="badge bg-success">
                <i class="bi bi-file-earmark-arrow-up"></i> Upload
              </span>
              {% else %}
              <span class="badge bg-secondary">{{ item.source }}</span>
              {% endif %}
            </td>
            <td>
              <small>{{ item.classified_at.strftime('%d/%m/%Y %H:%M') }}</small>
            </td>
            <td>
              <form
                method="POST"
                action="{{ url_for('delete_test_data', id=item.id) }}"
                style="display: inline"
                onsubmit="return confirm('Yakin ingin menghapus data ini?');"
              >
                <button type="submit" class="btn btn-danger btn-sm">
                  <i class="bi bi-trash"></i>
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    {% if pagination.pages > 1 %}
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center">
        <!-- Previous -->
        <li
          class="page-item {% if not pagination.has_prev %}disabled{% endif %}"
        >
          <a
            class="page-link"
            href="{{ url_for('data_test', page=pagination.prev_num) if pagination.has_prev else '#' }}"
          >
            <i class="bi bi-chevron-left"></i> Previous
          </a>
        </li>

        <!-- Page numbers -->
        {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1,
        left_current=2, right_current=2) %} {% if page_num %}
        <li
          class="page-item {% if page_num == pagination.page %}active{% endif %}"
        >
          <a class="page-link" href="{{ url_for('data_test', page=page_num) }}"
            >{{ page_num }}</a
          >
        </li>
        {% else %}
        <li class="page-item disabled">
          <span class="page-link">...</span>
        </li>
        {% endif %} {% endfor %}

        <!-- Next -->
        <li
          class="page-item {% if not pagination.has_next %}disabled{% endif %}"
        >
          <a
            class="page-link"
            href="{{ url_for('data_test', page=pagination.next_num) if pagination.has_next else '#' }}"
          >
            Next <i class="bi bi-chevron-right"></i>
          </a>
        </li>
      </ul>
    </nav>
    {% endif %}

    <!-- Summary -->
    <div class="text-center text-muted mt-3">
      <small>
        Menampilkan {{ (pagination.page - 1) * pagination.per_page + 1 }} - {%
        if pagination.page * pagination.per_page < pagination.total %} {{
        pagination.page * pagination.per_page }} {% else %} {{ pagination.total
        }} {% endif %} dari {{ pagination.total }} data uji
      </small>
    </div>
  </div>
</div>
{% endif %}

<!-- Info Card -->
<div class="card mt-4 border-info">
  <div class="card-header bg-info text-white">
    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Tentang Data Uji</h5>
  </div>
  <div class="card-body">
    <h6>Apa itu Data Uji?</h6>
    <p>
      Data uji adalah data abstrak yang sudah diklasifikasi oleh model KNN
      melalui
      <strong>Menu Klasifikasi</strong>. Data ini digunakan untuk:
    </p>
    <ul>
      <li>
        <strong>Evaluasi kinerja model</strong> - Melihat bagaimana model
        bekerja pada data baru
      </li>
      <li>
        <strong>Tracking prediksi</strong> - Menyimpan history klasifikasi
      </li>
      <li>
        <strong>Analisis distribusi</strong> - Melihat pola klasifikasi RPL vs
        TKJ
      </li>
    </ul>

    <h6 class="mt-3">Perbedaan dengan Data Latih:</h6>
    <div class="row">
      <div class="col-md-6">
        <div class="card bg-success bg-opacity-10">
          <div class="card-body">
            <h6 class="text-success">
              <i class="bi bi-database"></i> Data Latih (Training Data)
            </h6>
            <ul class="small mb-0">
              <li>Dari scraping ejournal.unesa.ac.id</li>
              <li>Label otomatis dengan keyword scoring</li>
              <li>Digunakan untuk <strong>melatih model</strong></li>
              <li>Total: <strong>312 data</strong> (242 RPL, 70 TKJ)</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card bg-info bg-opacity-10">
          <div class="card-body">
            <h6 class="text-info">
              <i class="bi bi-clipboard-data"></i> Data Uji (Test Data)
            </h6>
            <ul class="small mb-0">
              <li>Dari input manual & upload file</li>
              <li>Label prediksi dari model KNN</li>
              <li>Digunakan untuk <strong>evaluasi & tracking</strong></li>
              <li>Total: <strong>{{ stats.total }} data</strong></li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <div class="alert alert-warning mt-3 mb-0">
      <i class="bi bi-exclamation-triangle"></i>
      <strong>Catatan:</strong> Data uji <strong>TIDAK</strong> digunakan untuk
      training model. Jika ingin menambah data training, gunakan menu
      <a href="{{ url_for('scrape') }}" class="alert-link">Scrape Data</a>.
    </div>
  </div>
</div>

<!-- Modal Konfirmasi Hapus Semua -->
<div
  class="modal fade"
  id="clearAllModal"
  tabindex="-1"
  aria-labelledby="clearAllModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="clearAllModalLabel">
          <i class="bi bi-exclamation-triangle"></i> Konfirmasi Hapus Semua
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <p>
          Anda yakin ingin menghapus
          <strong>SEMUA {{ stats.total }} data uji</strong>?
        </p>
        <p class="text-danger mb-0">
          <i class="bi bi-exclamation-circle"></i>
          <strong>Peringatan:</strong> Tindakan ini tidak dapat dibatalkan!
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x"></i> Batal
        </button>
        <form
          method="POST"
          action="{{ url_for('clear_all_test_data') }}"
          style="display: inline"
        >
          <button type="submit" class="btn btn-danger">
            <i class="bi bi-trash"></i> Ya, Hapus Semua
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  // Enable tooltips
  var tooltipTriggerList = [].slice.call(
    document.querySelectorAll('[data-bs-toggle="tooltip"]')
  );
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
</script>

{% endblock %}
